<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Draw - Participate & Admin</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:"Segoe UI",Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;min-height:100vh}
  .container{max-width:760px;margin:0 auto;background:rgba(255,255,255,0.08);padding:18px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.35)}
  h1{text-align:center;margin-bottom:10px}
  .tabs{display:flex;gap:8px;background:rgba(0,0,0,0.2);padding:6px;border-radius:10px;margin-bottom:12px}
  .tab{flex:1;padding:10px;text-align:center;border-radius:8px;cursor:pointer;font-weight:700}
  .tab.active{background:#ff6b6b}
  .tab-content{display:none}
  .tab-content.active{display:block}
  form{margin-top:10px}
  .form-group{margin-bottom:14px}
  label{display:block;margin-bottom:6px;font-weight:700}
  input[type="text"],input[type="tel"],input[type="number"],input[type="password"]{width:100%;padding:10px;border-radius:8px;border:none;background:#fff;color:#111}
  .tokens-box{background:#fff;color:#111;padding:10px;border-radius:8px;font-weight:800;text-align:center}
  .payment-info{background:rgba(255,255,255,0.07);padding:12px;border-radius:8px;margin-bottom:12px}
  .note-box{background:rgba(255,255,255,0.06);padding:10px;border-radius:8px;margin-top:8px;color:#fff}
  .participants-approved{background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;margin-top:14px;max-height:260px;overflow:auto}
  .approved-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
  .badge{padding:6px 10px;border-radius:999px;font-weight:800}
  .badge.verified{background:#4ecdc4;color:#033}
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:800}
  .btn-primary{background:#ff6b6b;color:#fff}
  .btn-ghost{background:transparent;border:2px solid rgba(255,255,255,0.08);color:#fff}
  .admin-tools{margin-top:14px;padding:10px;background:rgba(0,0,0,0.18);border-radius:8px}
  .small{font-size:.9rem;opacity:.95}
  .flex{display:flex;gap:8px;align-items:center}
  @media(max-width:640px){.flex{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
  <div class="container">
    <h1>üéØ Participate & Admin</h1>

    <div class="tabs" role="tablist">
      <div class="tab active" data-target="participate-tab">Participate</div>
      <div class="tab" data-target="admin-tab">Admin Panel</div>
    </div>

    <!-- PARTICIPATE -->
    <div id="participate-tab" class="tab-content active">
      <div class="payment-info">
        <h3 class="small">üí≥ Payment Information (shown from admin settings)</h3>
        <div id="payment-details" class="small">Loading payment details‚Ä¶</div>
      </div>

      <form id="participate-form">
        <div class="form-group"><label for="name">Full Name *</label><input id="name" type="text" required></div>
        <div class="form-group"><label for="phone">Phone Number *</label><input id="phone" type="tel" required></div>
        <div class="form-group"><label for="amount">Amount (PKR) *</label>
          <input id="amount" type="number" min="250" step="250" required placeholder="250, 500, 1000, 2000">
        </div>

        <div class="form-group"><label for="txId">Transaction ID *</label><input id="txId" type="text" required placeholder="JazzCash Transaction ID"></div>

        <div class="form-group">
          <label>Tokens Earned</label>
          <div id="tokens-display" class="tokens-box">0 tokens</div>
        </div>

        <button class="btn btn-primary" id="submit-btn" type="submit">Submit Participation</button>
        <div id="form-message" style="margin-top:10px"></div>
      </form>

      <div class="note-box small">
        <strong>Important:</strong> Pay to the JazzCash number shown above, then enter the exact Transaction ID (TX ID). Please ensure your Transaction ID is correct ‚Äî incorrect or fake IDs will not be accepted.
      </div>

      <!-- Approved members box -->
      <div style="margin-top:16px">
        <h3 style="margin-bottom:8px">‚úÖ Recently Verified Participants</h3>
        <div class="participants-approved" id="approved-list">
          Loading verified participants...
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="admin-tab" class="tab-content">
      <div class="admin-tools">
        <div style="margin-bottom:8px">üîí Admin Access</div>
        <div class="flex" style="align-items:center">
          <input id="admin-password" type="password" placeholder="Enter admin password" style="flex:1;padding:10px;border-radius:8px;border:none">
          <button class="btn btn-ghost" id="admin-login-btn">Login</button>
        </div>
      </div>

      <div id="admin-panel" style="display:none; margin-top:12px">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:150px;background:rgba(255,255,255,0.03);padding:10px;border-radius:8px">
            <div class="small">Total Tokens</div>
            <div id="total-tokens" style="font-weight:800;font-size:20px">0</div>
          </div>
          <div style="flex:1;min-width:150px;background:rgba(255,255,255,0.03);padding:10px;border-radius:8px">
            <div class="small">Total Revenue (PKR)</div>
            <div id="total-revenue" style="font-weight:800;font-size:20px">0</div>
          </div>
        </div>

        <div style="margin-top:12px" class="small">
          <div style="margin-bottom:8px">‚öôÔ∏è Payment Settings</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="jazzcash-number" placeholder="JazzCash Number" style="padding:8px;border-radius:8px;border:none;flex:1">
            <input id="owner-name" placeholder="Owner Name" style="padding:8px;border-radius:8px;border:none;flex:1">
            <button class="btn btn-primary" id="update-settings-btn">Update Settings</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <h3 style="margin-bottom:8px">üìã Participants (admin view)</h3>
          <div id="participants-list" style="max-height:240px;overflow:auto;background:rgba(0,0,0,0.12);padding:10px;border-radius:8px">Loading...</div>
        </div>

        <div style="margin-top:12px">
          <h3 style="margin-bottom:8px">üîÅ Admin Refresh (password protected)</h3>
          <div class="flex">
            <input id="refresh-password" type="password" placeholder="Enter admin password to enable" style="padding:8px;border-radius:8px;border:none;flex:1">
            <button class="btn btn-primary" id="refresh-btn">Refresh Verified List</button>
          </div>
          <div class="small" style="margin-top:8px">After draw, press refresh to force reload verified participants.</div>
        </div>

        <div style="margin-top:12px">
          <a href="index.html" class="btn btn-ghost" style="text-decoration:none">‚¨ÖÔ∏è Back to Home</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script>
    // FIREBASE CONFIG (user-provided)
    const firebaseConfig = {
      apiKey: "AIzaSyC9XvQJohtUpZzgqunRgZngw5Akr2iNtGo",
      authDomain: "lucky-web-78c4f.firebaseapp.com",
      projectId: "lucky-web-78c4f",
      storageBucket: "lucky-web-78c4f.firebasestorage.app",
      messagingSenderId: "966619457091",
      appId: "1:966619457091:web:203193897b81de6eadd6f6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // state
    let isAdminAuthenticated = false;
    let cachedSettings = null;

    // TAB switching (safe)
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', (ev)=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        ev.currentTarget.classList.add('active');
        const target = ev.currentTarget.getAttribute('data-target');
        document.getElementById(target).classList.add('active');
      });
    });

    // Token mapping function (explicit mapping)
    function calculateTokens(amount){
      amount = Number(amount) || 0;
      if(amount === 250) return 1;
      if(amount === 500) return 2;
      if(amount === 1000) return 4;
      if(amount === 2000) return 8;
      // fallback: floor by 250
      return Math.floor(amount / 250);
    }

    // display tokens live
    document.getElementById('amount').addEventListener('input', function(){
      const tokens = calculateTokens(this.value);
      document.getElementById('tokens-display').textContent = `${tokens} tokens`;
    });

    // PARTICIPATE form submit
    document.getElementById('participate-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';

      const formData = {
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        amount: Number(document.getElementById('amount').value) || 0,
        txId: document.getElementById('txId').value.trim(),
        tokens: calculateTokens(document.getElementById('amount').value),
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // validation
      if(!formData.name || !formData.phone || !formData.amount || !formData.txId){
        showFormMessage('Please fill all required fields','error');
        submitBtn.disabled = false; submitBtn.textContent = 'Submit Participation';
        return;
      }
      if(formData.amount < 250){
        showFormMessage('Minimum amount is PKR 250','error');
        submitBtn.disabled = false; submitBtn.textContent = 'Submit Participation';
        return;
      }

      try{
        await db.collection('participants').add(formData);
        showFormMessage('Participation submitted. Keep your TX screenshot ‚Äî verification will follow.','success');
        document.getElementById('participate-form').reset();
        document.getElementById('tokens-display').textContent = '0 tokens';
      }catch(err){
        console.error('Submit error',err);
        showFormMessage('Error submitting ‚Äî try again','error');
      }finally{
        submitBtn.disabled = false; submitBtn.textContent = 'Submit Participation';
      }
    });

    function showFormMessage(text,type){
      const node = document.getElementById('form-message');
      node.innerHTML = `<div class="note-box ${type}">${text}</div>`;
      setTimeout(()=>{ node.innerHTML = '' },6000);
    }

    // Load payment info from settings/paymentInfo
    function loadPaymentInfo(){
      db.collection('settings').doc('paymentInfo').onSnapshot(doc=>{
        const el = document.getElementById('payment-details');
        if(!doc.exists){
          el.textContent = 'Payment details not configured';
          cachedSettings = null;
          return;
        }
        cachedSettings = doc.data();
        const owner = cachedSettings.ownerName || 'Owner';
        const jaz = cachedSettings.jazzcashNumber || 'Not set';
        el.innerHTML = `<div style="font-weight:800">${owner}</div><div style="margin-top:6px">Pay to: <strong>${jaz}</strong></div>`;
      }, err=>{ console.error('paymentInfo error',err) });
    }

    // masked phone helper (show first 3 and last 2, middle replaced)
    function maskPhone(p){
      if(!p) return '‚Äî';
      const s = p.toString();
      if(s.length <=5) return s;
      const first = s.slice(0,3);
      const last = s.slice(-2);
      return `${first}****${last}`;
    }

    // load participants list (admin view) + approved box (public)
    function loadParticipants(){
      const adminList = document.getElementById('participants-list');
      adminList.innerHTML = 'Loading...';
      const approvedBox = document.getElementById('approved-list');
      approvedBox.innerHTML = 'Loading verified participants...';

      db.collection('participants').orderBy('createdAt','desc').onSnapshot(snapshot=>{
        // admin list
        adminList.innerHTML = '';
        snapshot.forEach(doc=>{
          const d = doc.data();
          const id = doc.id;
          const status = d.status || 'pending';
          const container = document.createElement('div');
          container.style.marginBottom = '8px';
          container.style.padding = '8px';
          container.style.borderRadius = '8px';
          container.style.background = 'rgba(255,255,255,0.02)';
          container.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:800">${d.name||'‚Äî'}</div>
                <div class="small">üìû ${d.phone||'‚Äî'} | PKR ${d.amount||0} | ${d.tokens||0} tokens</div>
                <div class="small">TX: ${d.txId||'‚Äî'} | <strong>${(status||'pending').toUpperCase()}</strong></div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px">
                ${d.status === 'pending' ? `<button class="btn btn-primary" onclick="updateParticipantStatus('${id}','approved')">Approve</button>
                <button class="btn" style="background:#ff6b6b;color:#fff" onclick="updateParticipantStatus('${id}','rejected')">Reject</button>` : `<div class="badge verified"> ${d.status} </div>`}
              </div>
            </div>
          `;
          adminList.appendChild(container);
        });

        // approved participants (for public box)
        db.collection('participants').where('status','==','approved').orderBy('createdAt','desc').limit(10).get()
          .then(snap=>{
            approvedBox.innerHTML = '';
            if(snap.empty){
              approvedBox.innerHTML = '<div class="small">No verified participants yet</div>';
              return;
            }
            snap.forEach(doc=>{
              const d = doc.data();
              const item = document.createElement('div');
              item.className = 'approved-item';
              item.innerHTML = `<div style="font-weight:800">${d.name||'‚Äî'}</div>
                <div class="small">${maskPhone(d.phone)} | ${d.tokens||0} tokens</div>
              `;
              approvedBox.appendChild(item);
            });
          })
          .catch(err=>{ console.error('approved get err',err); approvedBox.innerHTML = 'Error loading verified participants' });
      }, err=>{ console.error('participants onSnapshot err',err); adminList.innerHTML = 'Error loading participants' });
    }

    // update participant status
    function updateParticipantStatus(docId,status){
      db.collection('participants').doc(docId).update({ status }).catch(err=>{
        console.error('status update err',err);
        alert('Error updating status');
      });
    }

    // load stats (approved)
    function loadStats(){
      db.collection('participants').where('status','==','approved').onSnapshot(snap=>{
        let totalTokens = 0, totalRevenue = 0;
        snap.forEach(doc=>{
          const d = doc.data();
          totalTokens += d.tokens || 0;
          totalRevenue += d.amount || 0;
        });
        document.getElementById('total-tokens').textContent = totalTokens;
        document.getElementById('total-revenue').textContent = totalRevenue.toLocaleString();
      }, err=>{ console.error('stats err',err) });
    }

    // Update payment settings (admin)
    document.getElementById('update-settings-btn').addEventListener('click', ()=>{
      const updates = {
        jazzcashNumber: document.getElementById('jazzcash-number').value.trim(),
        ownerName: document.getElementById('owner-name').value.trim()
      };
      db.collection('settings').doc('paymentInfo').set(updates,{merge:true})
        .then(()=>alert('Settings updated'))
        .catch(err=>{console.error('settings update err',err);alert('Error updating settings')});
    });

    // Admin login button (client-side check, uses paymentInfo.adminPasswordHash)
    document.getElementById('admin-login-btn').addEventListener('click', async ()=>{
      const pw = (document.getElementById('admin-password').value || '').trim();
      try{
        const doc = await db.collection('settings').doc('paymentInfo').get();
        if(!doc.exists){ alert('Settings not configured in Firestore'); return; }
        const s = doc.data();
        // default accept '123456' if adminPasswordHash absent (for convenience), else compare exact
        const expected = (s.adminPasswordHash || '').toString().trim();
        if(expected){
          if(expected === pw){
            isAdminAuthenticated = true;
          } else {
            alert('Invalid password');
            return;
          }
        } else {
          // if field missing, allow '123456' (only temporary)
          if(pw === '123456'){ isAdminAuthenticated = true; }
          else { alert('Invalid password'); return; }
        }
        // show admin panel
        document.getElementById('admin-panel').style.display = 'block';
        // populate settings fields
        document.getElementById('jazzcash-number').value = s.jazzcashNumber || '';
        document.getElementById('owner-name').value = s.ownerName || '';
        loadParticipants(); loadStats();
      }catch(err){ console.error('admin login err',err); alert('Error during admin login') }
    });

    // Refresh button (password-protected): will force reload approved list
    document.getElementById('refresh-btn').addEventListener('click', async ()=>{
      const pw = (document.getElementById('refresh-password').value || '').trim();
      // prefer checking against cachedSettings; if not cached, fetch
      let expected = '';
      if(cachedSettings && cachedSettings.adminPasswordHash) expected = (cachedSettings.adminPasswordHash||'').toString().trim();
      if(!expected){
        try{
          const doc = await db.collection('settings').doc('paymentInfo').get();
          if(doc.exists) expected = (doc.data().adminPasswordHash||'').toString().trim();
        }catch(err){ console.error('refresh pwd fetch err',err) }
      }
      // allow fallback secret 123456 if nothing in DB
      if(expected){
        if(pw !== expected){ alert('Invalid password'); return; }
      } else {
        if(pw !== '123456'){ alert('Invalid password'); return; }
      }
      // if passed, reload approved participants once
      reloadApprovedOnce();
      alert('Verified participants refreshed');
    });

    // reload approved participants once (used by refresh)
    function reloadApprovedOnce(){
      const approvedBox = document.getElementById('approved-list');
      approvedBox.innerHTML = 'Refreshing‚Ä¶';
      db.collection('participants').where('status','==','approved').orderBy('createdAt','desc').limit(10).get()
        .then(snap=>{
          approvedBox.innerHTML = '';
          if(snap.empty){ approvedBox.innerHTML = '<div class="small">No verified participants yet</div>'; return; }
          snap.forEach(doc=>{
            const d = doc.data();
            const item = document.createElement('div');
            item.className = 'approved-item';
            item.innerHTML = `<div style="font-weight:800">${d.name||'‚Äî'}</div>
              <div class="small">${maskPhone(d.phone)} | ${d.tokens||0} tokens</div>`;
            approvedBox.appendChild(item);
          });
        }).catch(err=>{ console.error('reload approved err',err); approvedBox.innerHTML = 'Error loading verified participants' });
    }

    // init: load payment info + participants list (public approved box)
    document.addEventListener('DOMContentLoaded', ()=>{
      loadPaymentInfo();
      // initial public approved box
      db.collection('participants').where('status','==','approved').orderBy('createdAt','desc').limit(10).get()
        .then(snap=>{
          const approvedBox = document.getElementById('approved-list');
          approvedBox.innerHTML = '';
          if(snap.empty){ approvedBox.innerHTML = '<div class="small">No verified participants yet</div>'; return; }
          snap.forEach(doc=>{
            const d = doc.data();
            const item = document.createElement('div');
            item.className = 'approved-item';
            item.innerHTML = `<div style="font-weight:800">${d.name||'‚Äî'}</div>
              <div class="small">${maskPhone(d.phone)} | ${d.tokens||0} tokens</div>`;
            approvedBox.appendChild(item);
          });
        }).catch(err=>{ console.error('init approved err',err); document.getElementById('approved-list').innerHTML = 'Error loading verified participants' });
    });
  </script>
</body>
</html>
